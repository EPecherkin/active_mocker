require 'active_mocker/mock_requires'
Object.send(:remove_const, "<%= class_name + @mock_append_name %>") if Object.const_defined?("<%= class_name + @mock_append_name %>")

class <%= class_name + @mock_append_name %> < ActiveMocker::Base
<% constants.each do |constant| %>
  <%= constant.first %> = <%= constant.last %>
<% end %>
  def initialize(attributes={}, &block)
    @attributes = HashWithIndifferentAccess.new(<%= attributes_with_defaults %>)
    @associations = HashWithIndifferentAccess.new(<%= associations %>)
    super(attributes, &block)
  end

  def self.mocked_class
    '<%= class_name %>'
  end

  def self.column_names
    <%= attribute_names %>
  end

  def self.attribute_names
    @attribute_names = <%= attribute_names %>
  end

  ##################################
  #   Attributes getter/setters    #
  ##################################
<% attributes.each do |meth| %>
  def <%= meth.name %>
    @attributes['<%= meth.name %>']
  end

  def <%= meth.name %>=(val)
    type = (types[:<%= meth.name %>] ||= Virtus::Attribute.build(<%= meth.ruby_type %>))
    @attributes['<%= meth.name %>'] = type.coerce(val)
    <% association = belongs_to.select{|r| r.foreign_key == meth.name}.first  -%>
    <% if association -%>
    <% klass = "#{association.class_name}Mock" -%>
    associations['<%= association.name %>'] = <%= klass %>.find(val) if defined? <%= klass %>
    <% end -%>
  end
<% end %>
  ##################################
  #         Associations           #
  ##################################
# belongs_to
<% belongs_to.each do |meth| %>
  def <%= meth.name %>
    associations['<%= meth.name %>']
  end

  def <%= meth.name %>=(val)
    associations['<%= meth.name %>'] = val
    write_attribute('<%= meth.foreign_key %>', val.id) if val.respond_to?(:persisted?) && val.persisted?
  end
<% end -%>
# has_one
<% has_one.each do |meth| %>
  def <%= meth.name %>
    associations['<%= meth.name %>']
  end

  def <%= meth.name %>=(val)
    associations['<%= meth.name %>'] = val
  end
<% end -%>
# has_many
<% has_many.each do |meth| %>
  def <%= meth.name %>
    associations['<%= meth.name %>'] ||= ActiveMocker::HasMany.new([],'<%= meth.foreign_key %>', @attributes['id'], '<%= meth.class_name + @mock_append_name %>')
  end

  def <%= meth.name %>=(val)
    associations['<%= meth.name %>'] ||= ActiveMocker::HasMany.new(val,'<%= meth.foreign_key %>', @attributes['id'], '<%= meth.class_name + @mock_append_name %>')
  end
<% end -%>
# has_and_belongs_to_many
<% has_and_belongs_to_many.each do |meth| %>
  def <%= meth.name %>
    associations['<%= meth.name %>'] ||= ActiveMocker::Association.new
  end

  def <%= meth.name %>=(val)
    associations['<%= meth.name %>'] = ActiveMocker::Association.new(val)
  end
<% end -%>

  ##################################
  #  Model Methods getter/setters  #
  ##################################

  def self.model_instance_methods
    @model_instance_methods ||= <%= instance_method_not_implemented %>
  end

  def self.model_class_methods
    @model_class_methods ||= <%= class_method_not_implemented %>
  end

  def self.clear_mock
    @foreign_keys,@model_class_methods, @model_instance_methods = nil, nil, nil
    delete_all
  end
<% instance_methods.each do |method| %>
  def <%= method.name %>(<%= method.arguments %>)
    block =  model_instance_methods['<%= method.name %>']
    self.class.is_implemented(block, '#<%= method.name %>')
    instance_exec(*[<%= method.arguments.passable %>], &block)
  end
<% end -%>
<% class_methods.each do |method| %>
  def self.<%= method.name %>(<%= method.arguments %>)
    block =  model_class_methods['<%= method.name %>']
    is_implemented(block, '::<%= method.name %>')
    instance_exec(*[<%= method.arguments.passable %>], &block)
  end
<% end -%>

  def self.reload
    load __FILE__
  end

end